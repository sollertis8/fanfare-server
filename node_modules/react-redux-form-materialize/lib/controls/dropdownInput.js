'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _omit = require('lodash/omit');

var _omit2 = _interopRequireDefault(_omit);

var _map = require('lodash/map');

var _map2 = _interopRequireDefault(_map);

var _inputHelpers = require('../helpers/inputHelpers');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const defaultUlStyle = {
  position: 'absolute',
  top: 0,
  left: 0,
  opacity: 1,
  width: '100%'
};

function renderChild(dropdownInput, { props: { disabled, value, children } }) {
  const { innerState } = dropdownInput.props;

  const liClass = (0, _classnames2.default)({
    disabled,
    active: value === innerState.value,
    selected: value === innerState.value
  });

  return _react2.default.createElement(
    'li',
    { className: liClass, key: value, 'data-value': value, 'data-disabled': disabled,
      onMouseDown: dropdownInput.onDropdownClick },
    _react2.default.createElement(
      'span',
      null,
      children
    )
  );
}

const defaultCaret = _react2.default.createElement(
  'span',
  { className: 'caret' },
  '\u25BC'
);

class DropdownInput extends _react2.default.Component {

  constructor(props) {
    super(props);

    this.onPageClick = () => {
      this.setState({ showSelect: false });
    };

    this.onShow = () => {
      if (this.props.disabled) {
        return;
      }
      this.setState({ showSelect: true });
    };

    this.onDropdownClick = evnt => {
      evnt.stopPropagation();
      const { currentTarget: { dataset: { value, disabled } } } = evnt;
      if (disabled) {
        return;
      }
      this.setState({ showSelect: false });
      this.props.onChange(value);
    };

    this.onPreventPropagation = evnt => {
      evnt.stopPropagation();
    };

    this.state = { showSelect: false };
  }

  componentDidMount() {
    if (typeof window !== 'undefined') {
      window.addEventListener('mousedown', this.onPageClick, false);
    }
  }

  componentWillUnmount() {
    if (typeof window !== 'undefined') {
      window.removeEventListener('mousedown', this.onPageClick);
    }
  }

  render() {
    const { props } = this;
    const { showSelect } = this.state;

    const errors = (0, _inputHelpers.getErrors)(props);

    const fieldClassName = (0, _classnames2.default)('input-field', props.className);

    const disabled = props.disabled ? 'disabled' : false;

    const iconColor = (0, _inputHelpers.getIconColor)(props);

    const selectWrapperClassName = (0, _classnames2.default)('select-wrapper', props.selectClassName);

    const inputClassName = (0, _classnames2.default)('select-dropdown', 'validate', 'active', {
      invalid: errors.length
    }, props.inputClassName);

    const ulClassName = (0, _classnames2.default)('dropdown-content', 'select-dropdown', 'active', props.ulClassName);

    const labelClassName = (0, _inputHelpers.getLabelClassName)(props, errors);

    const ulStyle = Object.assign({
      display: showSelect ? 'block' : 'none'
    }, defaultUlStyle);

    const selectProps = (0, _omit2.default)(props, ['placeholder', 'innerState', 'iconPrefix', 'className', 'selectClassName', 'messages', 'iconFactory', 'selectTagClassName', 'inputClassName', 'caretClassName', 'ulClassName', 'renderChild', 'caret']);

    selectProps.className = props.selectTagClassName;

    const selectedItem = props.value ? props.children.find(chld => chld.props.value.toString() === props.value.toString()) : undefined;

    const labelStyle = {
      top: errors.length ? '60px' : '0.8rem'
    };

    const PrefixIcon = props.iconPrefix ? props.iconFactory(props.iconPrefix) : undefined;

    return _react2.default.createElement(
      'div',
      { className: fieldClassName },
      PrefixIcon && _react2.default.createElement(PrefixIcon, { style: { left: '0px' }, className: 'prefix', color: iconColor }),
      _react2.default.createElement(
        'div',
        { className: selectWrapperClassName, onMouseDown: this.onPreventPropagation },
        this.props.caret,
        _react2.default.createElement('input', { type: 'text',
          className: inputClassName,
          readOnly: true,
          disabled: disabled,
          onClick: this.onShow,
          value: selectedItem && selectedItem.props.children
        }),
        _react2.default.createElement(
          'ul',
          { className: ulClassName, style: ulStyle },
          (0, _map2.default)(props.children, childProps => this.props.renderChild(this, childProps))
        ),
        _react2.default.createElement(
          'select',
          (0, _extends3.default)({}, selectProps, { disabled: disabled }),
          props.children
        )
      ),
      _react2.default.createElement(
        'label',
        { htmlFor: props.id, className: labelClassName, style: labelStyle,
          'data-error': errors },
        props.placeholder
      )
    );
  }
}
exports.default = DropdownInput;
DropdownInput.propTypes = {
  innerState: _propTypes2.default.object.isRequired,
  iconPrefix: _propTypes2.default.string,
  iconFactory: _propTypes2.default.func,
  messages: _propTypes2.default.object,
  selectClassName: _propTypes2.default.string,
  selectTagClassName: _propTypes2.default.string,
  inputClassName: _propTypes2.default.string,
  caretClassName: _propTypes2.default.string,
  renderChild: _propTypes2.default.func.isRequired,
  caret: _propTypes2.default.element
};
DropdownInput.defaultProps = {
  renderChild,
  caret: defaultCaret
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9scy9kcm9wZG93bklucHV0LmpzIl0sIm5hbWVzIjpbImRlZmF1bHRVbFN0eWxlIiwicG9zaXRpb24iLCJ0b3AiLCJsZWZ0Iiwib3BhY2l0eSIsIndpZHRoIiwicmVuZGVyQ2hpbGQiLCJkcm9wZG93bklucHV0IiwicHJvcHMiLCJkaXNhYmxlZCIsInZhbHVlIiwiY2hpbGRyZW4iLCJpbm5lclN0YXRlIiwibGlDbGFzcyIsImFjdGl2ZSIsInNlbGVjdGVkIiwib25Ecm9wZG93bkNsaWNrIiwiZGVmYXVsdENhcmV0IiwiRHJvcGRvd25JbnB1dCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwib25QYWdlQ2xpY2siLCJzZXRTdGF0ZSIsInNob3dTZWxlY3QiLCJvblNob3ciLCJldm50Iiwic3RvcFByb3BhZ2F0aW9uIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJvbkNoYW5nZSIsIm9uUHJldmVudFByb3BhZ2F0aW9uIiwic3RhdGUiLCJjb21wb25lbnREaWRNb3VudCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJyZW5kZXIiLCJlcnJvcnMiLCJmaWVsZENsYXNzTmFtZSIsImNsYXNzTmFtZSIsImljb25Db2xvciIsInNlbGVjdFdyYXBwZXJDbGFzc05hbWUiLCJzZWxlY3RDbGFzc05hbWUiLCJpbnB1dENsYXNzTmFtZSIsImludmFsaWQiLCJsZW5ndGgiLCJ1bENsYXNzTmFtZSIsImxhYmVsQ2xhc3NOYW1lIiwidWxTdHlsZSIsIk9iamVjdCIsImFzc2lnbiIsImRpc3BsYXkiLCJzZWxlY3RQcm9wcyIsInNlbGVjdFRhZ0NsYXNzTmFtZSIsInNlbGVjdGVkSXRlbSIsImZpbmQiLCJjaGxkIiwidG9TdHJpbmciLCJ1bmRlZmluZWQiLCJsYWJlbFN0eWxlIiwiUHJlZml4SWNvbiIsImljb25QcmVmaXgiLCJpY29uRmFjdG9yeSIsImNhcmV0IiwiY2hpbGRQcm9wcyIsImlkIiwicGxhY2Vob2xkZXIiLCJwcm9wVHlwZXMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwic3RyaW5nIiwiZnVuYyIsIm1lc3NhZ2VzIiwiY2FyZXRDbGFzc05hbWUiLCJlbGVtZW50IiwiZGVmYXVsdFByb3BzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBRUEsTUFBTUEsaUJBQWlCO0FBQ3JCQyxZQUFVLFVBRFc7QUFFckJDLE9BQUssQ0FGZ0I7QUFHckJDLFFBQU0sQ0FIZTtBQUlyQkMsV0FBUyxDQUpZO0FBS3JCQyxTQUFPO0FBTGMsQ0FBdkI7O0FBUUEsU0FBU0MsV0FBVCxDQUFxQkMsYUFBckIsRUFBb0MsRUFBRUMsT0FBTyxFQUFFQyxRQUFGLEVBQVlDLEtBQVosRUFBbUJDLFFBQW5CLEVBQVQsRUFBcEMsRUFBOEU7QUFDNUUsUUFBTSxFQUFFQyxVQUFGLEtBQWlCTCxjQUFjQyxLQUFyQzs7QUFFQSxRQUFNSyxVQUFVLDBCQUFHO0FBQ2pCSixZQURpQjtBQUVqQkssWUFBUUosVUFBVUUsV0FBV0YsS0FGWjtBQUdqQkssY0FBVUwsVUFBVUUsV0FBV0Y7QUFIZCxHQUFILENBQWhCOztBQU1BLFNBQ0U7QUFBQTtBQUFBLE1BQUksV0FBV0csT0FBZixFQUF3QixLQUFLSCxLQUE3QixFQUFvQyxjQUFZQSxLQUFoRCxFQUF1RCxpQkFBZUQsUUFBdEU7QUFDSSxtQkFBYUYsY0FBY1MsZUFEL0I7QUFFRTtBQUFBO0FBQUE7QUFBT0w7QUFBUDtBQUZGLEdBREY7QUFNRDs7QUFFRCxNQUFNTSxlQUNKO0FBQUE7QUFBQSxJQUFNLFdBQVUsT0FBaEI7QUFBQTtBQUFBLENBREY7O0FBSWUsTUFBTUMsYUFBTixTQUE0QixnQkFBTUMsU0FBbEMsQ0FBNEM7O0FBbUJ6REMsY0FBWVosS0FBWixFQUFtQjtBQUNqQixVQUFNQSxLQUFOOztBQURpQixTQWlCbkJhLFdBakJtQixHQWlCTCxNQUFN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RUFBMEIsV0FBV2xCLGNBQXJDLEVBQXFELE9BQU9ZLFVBQTVEO0FBQ08sd0JBQVl0QixNQURuQjtBQUM0QjlCLGNBQU0yRDtBQURsQztBQXZCRixLQURGO0FBNEJEO0FBakp3RDtrQkFBdENqRCxhO0FBQUFBLGEsQ0FDWmtELFMsR0FBWTtBQUNqQnhELGNBQVksb0JBQVV5RCxNQUFWLENBQWlCQyxVQURaO0FBRWpCUixjQUFZLG9CQUFVUyxNQUZMO0FBR2pCUixlQUFhLG9CQUFVUyxJQUhOO0FBSWpCQyxZQUFVLG9CQUFVSixNQUpIO0FBS2pCMUIsbUJBQWlCLG9CQUFVNEIsTUFMVjtBQU1qQmpCLHNCQUFvQixvQkFBVWlCLE1BTmI7QUFPakIzQixrQkFBZ0Isb0JBQVUyQixNQVBUO0FBUWpCRyxrQkFBZ0Isb0JBQVVILE1BUlQ7QUFTakJqRSxlQUFhLG9CQUFVa0UsSUFBVixDQUFlRixVQVRYO0FBVWpCTixTQUFPLG9CQUFVVztBQVZBLEM7QUFEQXpELGEsQ0FjWjBELFksR0FBZTtBQUNwQnRFLGFBRG9CO0FBRXBCMEQsU0FBTy9DO0FBRmEsQyIsImZpbGUiOiJkcm9wZG93bklucHV0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgY24gZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgb21pdCBmcm9tICdsb2Rhc2gvb21pdCc7XG5pbXBvcnQgbWFwIGZyb20gJ2xvZGFzaC9tYXAnO1xuXG5pbXBvcnQgeyBnZXRFcnJvcnMsIGdldEljb25Db2xvciwgZ2V0TGFiZWxDbGFzc05hbWUgfSBmcm9tICcuLi9oZWxwZXJzL2lucHV0SGVscGVycyc7XG5cbmNvbnN0IGRlZmF1bHRVbFN0eWxlID0ge1xuICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgdG9wOiAwLFxuICBsZWZ0OiAwLFxuICBvcGFjaXR5OiAxLFxuICB3aWR0aDogJzEwMCUnLFxufTtcblxuZnVuY3Rpb24gcmVuZGVyQ2hpbGQoZHJvcGRvd25JbnB1dCwgeyBwcm9wczogeyBkaXNhYmxlZCwgdmFsdWUsIGNoaWxkcmVuIH0gfSkge1xuICBjb25zdCB7IGlubmVyU3RhdGUgfSA9IGRyb3Bkb3duSW5wdXQucHJvcHM7XG5cbiAgY29uc3QgbGlDbGFzcyA9IGNuKHtcbiAgICBkaXNhYmxlZCxcbiAgICBhY3RpdmU6IHZhbHVlID09PSBpbm5lclN0YXRlLnZhbHVlLFxuICAgIHNlbGVjdGVkOiB2YWx1ZSA9PT0gaW5uZXJTdGF0ZS52YWx1ZSxcbiAgfSk7XG5cbiAgcmV0dXJuIChcbiAgICA8bGkgY2xhc3NOYW1lPXtsaUNsYXNzfSBrZXk9e3ZhbHVlfSBkYXRhLXZhbHVlPXt2YWx1ZX0gZGF0YS1kaXNhYmxlZD17ZGlzYWJsZWR9XG4gICAgICAgIG9uTW91c2VEb3duPXtkcm9wZG93bklucHV0Lm9uRHJvcGRvd25DbGlja30+XG4gICAgICA8c3Bhbj57Y2hpbGRyZW59PC9zcGFuPlxuICAgIDwvbGk+XG4gICk7XG59XG5cbmNvbnN0IGRlZmF1bHRDYXJldCA9IChcbiAgPHNwYW4gY2xhc3NOYW1lPVwiY2FyZXRcIj7ilrw8L3NwYW4+XG4pO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEcm9wZG93bklucHV0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBpbm5lclN0YXRlOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgaWNvblByZWZpeDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBpY29uRmFjdG9yeTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgbWVzc2FnZXM6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgc2VsZWN0Q2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIHNlbGVjdFRhZ0NsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBpbnB1dENsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjYXJldENsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICByZW5kZXJDaGlsZDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICBjYXJldDogUHJvcFR5cGVzLmVsZW1lbnQsXG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIHJlbmRlckNoaWxkLFxuICAgIGNhcmV0OiBkZWZhdWx0Q2FyZXQsXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLnN0YXRlID0geyBzaG93U2VsZWN0OiBmYWxzZSB9O1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5vblBhZ2VDbGljaywgZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMub25QYWdlQ2xpY2spO1xuICAgIH1cbiAgfVxuXG4gIG9uUGFnZUNsaWNrID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoeyBzaG93U2VsZWN0OiBmYWxzZSB9KTtcbiAgfVxuXG4gIG9uU2hvdyA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5wcm9wcy5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNldFN0YXRlKHsgc2hvd1NlbGVjdDogdHJ1ZSB9KTtcbiAgfVxuXG4gIG9uRHJvcGRvd25DbGljayA9IChldm50KSA9PiB7XG4gICAgZXZudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICBjb25zdCB7IGN1cnJlbnRUYXJnZXQ6IHsgZGF0YXNldDogeyB2YWx1ZSwgZGlzYWJsZWQgfSB9IH0gPSBldm50O1xuICAgIGlmIChkaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNldFN0YXRlKHsgc2hvd1NlbGVjdDogZmFsc2UgfSk7XG4gICAgdGhpcy5wcm9wcy5vbkNoYW5nZSh2YWx1ZSk7XG4gIH1cblxuICBvblByZXZlbnRQcm9wYWdhdGlvbiA9IChldm50KSA9PiB7XG4gICAgZXZudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc2hvd1NlbGVjdCB9ID0gdGhpcy5zdGF0ZTtcblxuICAgIGNvbnN0IGVycm9ycyA9IGdldEVycm9ycyhwcm9wcyk7XG5cbiAgICBjb25zdCBmaWVsZENsYXNzTmFtZSA9IGNuKCdpbnB1dC1maWVsZCcsIHByb3BzLmNsYXNzTmFtZSk7XG5cbiAgICBjb25zdCBkaXNhYmxlZCA9IHByb3BzLmRpc2FibGVkID8gJ2Rpc2FibGVkJyA6IGZhbHNlO1xuXG4gICAgY29uc3QgaWNvbkNvbG9yID0gZ2V0SWNvbkNvbG9yKHByb3BzKTtcblxuICAgIGNvbnN0IHNlbGVjdFdyYXBwZXJDbGFzc05hbWUgPSBjbignc2VsZWN0LXdyYXBwZXInLCBwcm9wcy5zZWxlY3RDbGFzc05hbWUpO1xuXG4gICAgY29uc3QgaW5wdXRDbGFzc05hbWUgPSBjbignc2VsZWN0LWRyb3Bkb3duJywgJ3ZhbGlkYXRlJywgJ2FjdGl2ZScsIHtcbiAgICAgIGludmFsaWQ6IGVycm9ycy5sZW5ndGgsXG4gICAgfSwgcHJvcHMuaW5wdXRDbGFzc05hbWUpO1xuXG4gICAgY29uc3QgdWxDbGFzc05hbWUgPSBjbignZHJvcGRvd24tY29udGVudCcsICdzZWxlY3QtZHJvcGRvd24nLCAnYWN0aXZlJywgcHJvcHMudWxDbGFzc05hbWUpO1xuXG4gICAgY29uc3QgbGFiZWxDbGFzc05hbWUgPSBnZXRMYWJlbENsYXNzTmFtZShwcm9wcywgZXJyb3JzKTtcblxuICAgIGNvbnN0IHVsU3R5bGUgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgIGRpc3BsYXk6IHNob3dTZWxlY3QgPyAnYmxvY2snIDogJ25vbmUnLFxuICAgIH0sIGRlZmF1bHRVbFN0eWxlKTtcblxuICAgIGNvbnN0IHNlbGVjdFByb3BzID0gb21pdChwcm9wcywgW1xuICAgICAgJ3BsYWNlaG9sZGVyJyxcbiAgICAgICdpbm5lclN0YXRlJyxcbiAgICAgICdpY29uUHJlZml4JyxcbiAgICAgICdjbGFzc05hbWUnLFxuICAgICAgJ3NlbGVjdENsYXNzTmFtZScsXG4gICAgICAnbWVzc2FnZXMnLFxuICAgICAgJ2ljb25GYWN0b3J5JyxcbiAgICAgICdzZWxlY3RUYWdDbGFzc05hbWUnLFxuICAgICAgJ2lucHV0Q2xhc3NOYW1lJyxcbiAgICAgICdjYXJldENsYXNzTmFtZScsXG4gICAgICAndWxDbGFzc05hbWUnLFxuICAgICAgJ3JlbmRlckNoaWxkJyxcbiAgICAgICdjYXJldCcsXG4gICAgXSk7XG5cbiAgICBzZWxlY3RQcm9wcy5jbGFzc05hbWUgPSBwcm9wcy5zZWxlY3RUYWdDbGFzc05hbWU7XG5cbiAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSBwcm9wcy52YWx1ZVxuICAgICAgPyBwcm9wcy5jaGlsZHJlbi5maW5kKGNobGQgPT4gY2hsZC5wcm9wcy52YWx1ZS50b1N0cmluZygpID09PSBwcm9wcy52YWx1ZS50b1N0cmluZygpKVxuICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBsYWJlbFN0eWxlID0ge1xuICAgICAgdG9wOiBlcnJvcnMubGVuZ3RoID8gJzYwcHgnIDogJzAuOHJlbScsXG4gICAgfTtcblxuICAgIGNvbnN0IFByZWZpeEljb24gPSBwcm9wcy5pY29uUHJlZml4XG4gICAgICA/IHByb3BzLmljb25GYWN0b3J5KHByb3BzLmljb25QcmVmaXgpXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17ZmllbGRDbGFzc05hbWV9PlxuICAgICAgICB7UHJlZml4SWNvbiAmJlxuICAgICAgICA8UHJlZml4SWNvbiBzdHlsZT17eyBsZWZ0OiAnMHB4JyB9fSBjbGFzc05hbWU9XCJwcmVmaXhcIiBjb2xvcj17aWNvbkNvbG9yfS8+XG4gICAgICAgIH1cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9e3NlbGVjdFdyYXBwZXJDbGFzc05hbWV9IG9uTW91c2VEb3duPXt0aGlzLm9uUHJldmVudFByb3BhZ2F0aW9ufT5cbiAgICAgICAgICB7dGhpcy5wcm9wcy5jYXJldH1cbiAgICAgICAgICA8aW5wdXQgdHlwZT1cInRleHRcIlxuICAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2lucHV0Q2xhc3NOYW1lfVxuICAgICAgICAgICAgICAgICByZWFkT25seT17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVkfVxuICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uU2hvd31cbiAgICAgICAgICAgICAgICAgdmFsdWU9e3NlbGVjdGVkSXRlbSAmJiBzZWxlY3RlZEl0ZW0ucHJvcHMuY2hpbGRyZW59XG4gICAgICAgICAgLz5cbiAgICAgICAgICA8dWwgY2xhc3NOYW1lPXt1bENsYXNzTmFtZX0gc3R5bGU9e3VsU3R5bGV9PlxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBtYXAocHJvcHMuY2hpbGRyZW4sIGNoaWxkUHJvcHMgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLnJlbmRlckNoaWxkKHRoaXMsIGNoaWxkUHJvcHMpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvdWw+XG4gICAgICAgICAgPHNlbGVjdCB7Li4uc2VsZWN0UHJvcHN9IGRpc2FibGVkPXtkaXNhYmxlZH0+XG4gICAgICAgICAgICB7cHJvcHMuY2hpbGRyZW59XG4gICAgICAgICAgPC9zZWxlY3Q+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8bGFiZWwgaHRtbEZvcj17cHJvcHMuaWR9IGNsYXNzTmFtZT17bGFiZWxDbGFzc05hbWV9IHN0eWxlPXtsYWJlbFN0eWxlfVxuICAgICAgICAgICAgICAgZGF0YS1lcnJvcj17ZXJyb3JzfT57cHJvcHMucGxhY2Vob2xkZXJ9PC9sYWJlbD5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cbn1cblxuIl19